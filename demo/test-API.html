<script src="../dist/hls.min.js"></script>
<!--<script src="../dist/hls.min.js"></script>-->
<video id="video" controls></video>
<p id="version"></p>
<h3>download info:</h3>
<p id="info"></p>
<table id="table-body">
    <tbody ></tbody>
</table>
<script>
    document.querySelector('#version').innerText = `hls.js version: ${Hls.version}  cdnbye version: ${Hls.engineVersion}`;
    if(Hls.isSupported()) {
        var video = document.getElementById('video');
        var hls = new Hls({p2pConfig: {
            logLevel: 'debug',
            p2pEnabled: true,
                // announce: 'https://tracker.klink.tech',
            // wsSignalerAddr: 'wss://free.freesignal.net',
            //     announce: "https://tracker.cdnbye.com:8090/v1",
            segmentId: function (level, sn, url) {
                console.warn(`segmentId level ${level} sn ${sn} url ${url}`);
                return `${level}-${sn}`
            },
            channelId: function (m3u8Url) {
                console.warn(`m3u8Url ${m3u8Url}`);
                return m3u8Url;
            },
            validateSegment: function (level, sn, buffer) {
                console.warn(`validateSegment level ${level} sn ${sn}`);
                return true;
            },
            getStats: function (totalP2PDownloaded, totalP2PUploaded, totalHTTPDownloaded) {
                console.warn(`p2pConfig`);
                console.warn(`totalP2PDownloaded ${totalP2PDownloaded} totalP2PUploaded ${totalP2PUploaded} totalHTTPDownloaded ${totalHTTPDownloaded}`)
            },
            getPeerId: function (peerId) {
                console.warn(`p2pConfig`);
                console.warn(`peerId ${peerId}`)
            },
            getPeersInfo: function (peers) {
                console.warn(`p2pConfig`);
                console.warn(`peers: ${peers}`)
            }
        }});
       hls.loadSource('https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8');
        // hls.loadSource('https://video-dev.github.io/streams/x36xhzz/x36xhzz.m3u8');
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED,function(event, data) {
            video.play();
        });
        var total = 0, p2p = 0;
        hls.on(Hls.Events.FRAG_LOADED, (id, data) => {
            var frag = data.frag;
//            console.log(`frag.loadByP2P ${frag.loadByP2P} frag.loadByHTTP ${frag.loadByHTTP}`)
            var source = undefined;
            if (frag.loadByHTTP === true || frag.loadByHTTP === undefined) {
                source = 'CDN';
            } else if (frag.loadByP2P === true) {
                source = 'P2P';
            }
            addToTable(frag.relurl, frag.loaded, source);
            total += frag.loaded;
            if (source === 'P2P') p2p += frag.loaded;
            document.querySelector('#info').innerText = `p2p ratio: ${Math.round(p2p/total*100)}%   saved traffic: ${Math.round(p2p/1024)}KB`;
        });
        function addToTable(url, downloaded, source) {
            var infoStr = `download ${url}(size:${downloaded}B) by ${source}`;
            document.querySelector('#table-body tbody').innerHTML +=
                `<tr style="text-align: center">
                    <td>${infoStr}</td>
                </tr>`
        };

//        console.warn(`test engineVersion ${Hls.engineVersion}`);
//        console.warn(`test WEBRTC_SUPPORT ${Hls.WEBRTC_SUPPORT}`);

        hls.p2pEngine.on('peerId', function (peerId) {
           console.warn(`test peerId`);
           console.warn(`peerId: ${peerId}`)
        });

        hls.p2pEngine.on('peers', function (peers) {
           console.warn(`test peers`);
           console.warn(`peers: ${peers}`)
        });

        hls.p2pEngine.on('stats', function (stats) {
           console.warn(`test stats`);
           console.warn(`stats: ${JSON.stringify(stats)}`)
        });

        window.setTimeout(function () {
            hls.p2pEngine.disableP2P();
           // hls.destroy();
//

        }, 30000);

        window.setTimeout(function () {
            hls.p2pEngine.enableP2P();
        }, 50000);
    }
</script>
